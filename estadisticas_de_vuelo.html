<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Estad√≠sticas de Vuelo</title>
    <link rel="stylesheer" href="esdtadistica de vuelo.css">
    
    
</head>
<body>
    <div class="container">
        <h2>üìà Estad√≠sticas de Vuelo (Historial)</h2>
        
        <form id="statsForm">
            <label for="zabbixUrl">URL de la API de Zabbix:</label>
            <input type="text" id="zabbixUrl" value="https://TU-INSTANCIA-CLOUD/api_jsonrpc.php" required>
            
            <label for="authToken">Token de Autenticaci√≥n:</label>
            <input type="text" id="authToken" placeholder="Ingresa el token (Auth ID)" required>
            
            <label for="itemId">ID del √çtem a Medir ("Vuelo"):</label>
            <input type="text" id="itemId" placeholder="Ej: 23456" required>

            <label for="timeFrom">Fecha y Hora de Inicio:</label>
            <input type="datetime-local" id="timeFrom" required>
            
            <label for="timeTill">Fecha y Hora de Fin:</label>
            <input type="datetime-local" id="timeTill" required>

            <button type="submit">Calcular Estad√≠sticas</button>
        </form>
        
        <div id="message"></div>

        <div id="statsResult" class="stats-box">
            <p><strong>N√∫mero de Muestras:</strong> <span id="sampleCount">---</span></p>
            <p><strong>Valor Promedio:</strong> <span id="averageValue">---</span></p>
            <p><strong>Valor M√≠nimo:</strong> <span id="minValue">---</span></p>
            <p><strong>Valor M√°ximo:</strong> <span id="maxValue">---</span></p>
        </div>
    </div>

    <script>
        document.getElementById('statsForm').addEventListener('submit', function(e) {
            e.preventDefault();
            getHistoricalStats();
        });

        function makeApiCall(method, params, auth) {
            const url = document.getElementById('zabbixUrl').value;
            const payload = {
                "jsonrpc": "2.0",
                "method": method,
                "params": params,
                "auth": auth,
                "id": 1
            };
            
            return fetch(url, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload)
            }).then(response => response.json());
        }

        function dateToUnixTimestamp(datetimeLocalString) {
            if (!datetimeLocalString) return 0;
            // La API de Zabbix espera el timestamp en segundos
            return Math.floor(new Date(datetimeLocalString).getTime() / 1000);
        }

        async function getHistoricalStats() {
            const authToken = document.getElementById('authToken').value;
            const itemId = document.getElementById('itemId').value;
            const timeFrom = dateToUnixTimestamp(document.getElementById('timeFrom').value);
            const timeTill = dateToUnixTimestamp(document.getElementById('timeTill').value);
            const messageDiv = document.getElementById('message');
            
            // Tipo de historial: 0 (num√©rico float) es el m√°s com√∫n para estad√≠sticas
            const historyType = 0; 
            
            messageDiv.textContent = 'Obteniendo datos hist√≥ricos...';
            messageDiv.style.color = '#333';

            // --- 1. Par√°metros para history.get ---
            const historyParams = {
                output: "extend",
                history: historyType,
                itemids: [itemId],
                time_from: timeFrom,
                time_till: timeTill,
                sortfield: "clock",
                sortorder: "DESC"
            };

            try {
                // --- 2. Llamar al m√©todo history.get ---
                const data = await makeApiCall("history.get", historyParams, authToken);
                
                if (data.error) {
                    messageDiv.style.color = 'red';
                    messageDiv.textContent = `üö´ Error de API: ${data.error.data || data.error.message}. Verifica tus permisos, token o el ID del √≠tem.`;
                    
                } else if (data.result && data.result.length > 0) {
                    const values = data.result.map(entry => parseFloat(entry.value));
                    
                    // --- 3. Calcular estad√≠sticas ---
                    const total = values.reduce((sum, value) => sum + value, 0);
                    const average = total / values.length;
                    const min = Math.min(...values);
                    const max = Math.max(...values);
                    
                    messageDiv.style.color = 'green';
                    messageDiv.textContent = `‚úÖ ${values.length} muestras analizadas con √©xito.`;

                    // Mostrar los resultados
                    document.getElementById('sampleCount').textContent = values.length;
                    document.getElementById('averageValue').textContent = average.toFixed(2);
                    document.getElementById('minValue').textContent = min;
                    document.getElementById('maxValue').textContent = max;

                } else {
                    messageDiv.style.color = 'orange';
                    document.getElementById('sampleCount').textContent = '0';
                    document.getElementById('averageValue').textContent = '---';
                    document.getElementById('minValue').textContent = '---';
                    document.getElementById('maxValue').textContent = '---';
                    messageDiv.textContent = `‚ö†Ô∏è No se encontraron datos hist√≥ricos para el √çtem ${itemId} en el rango de tiempo especificado.`;
                }

            } catch (error) {
                messageDiv.style.color = 'red';
                messageDiv.textContent = `‚ùå Error de conexi√≥n: ${error.message}`;
            }
        }
    </script>
</body>
</html>