<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tr√°fico de Vuelo</title>
    <link rel="stylesheet" href="trafico de vuelo.css">

</head>
<body>
    <div class="container">
        <h2>üö• Tr√°fico de Vuelo (Lista de Hosts Activos)</h2>
        
        <form id="trafficForm">
            <label for="zabbixUrl">URL de la API de Zabbix:</label>
            <input type="text" id="zabbixUrl" value="https://TU-INSTANCIA-CLOUD/api_jsonrpc.php" required>
            
            <label for="authToken">Token de Autenticaci√≥n:</label>
            <input type="text" id="authToken" placeholder="Ingresa el token (Auth ID)" required>
            
            <button type="submit">Obtener Tr√°fico de Vuelos</button>
        </form>
        
        <div id="message"></div>

        <div id="hostList" class="host-list">
            </div>
    </div>

    <script>
        document.getElementById('trafficForm').addEventListener('submit', function(e) {
            e.preventDefault();
            getHostTraffic();
        });

        function makeApiCall(method, params, auth) {
            const url = document.getElementById('zabbixUrl').value;
            const payload = {
                "jsonrpc": "2.0",
                "method": method,
                "params": params,
                "auth": auth,
                "id": 1
            };
            
            return fetch(url, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload)
            }).then(response => response.json());
        }

        function getHostStatusText(status) {
            return status == 0 ? 'Habilitado' : 'Deshabilitado';
        }

        function getAgentAvailability(available) {
            if (available == 1) return '<span class="status-icon available-1"></span> Disponible (UP)';
            if (available == 2) return '<span class="status-icon available-2"></span> No Disponible (DOWN)';
            return 'Desconocido/No Monitoreado';
        }

        async function getHostTraffic() {
            const authToken = document.getElementById('authToken').value;
            const messageDiv = document.getElementById('message');
            const hostListDiv = document.getElementById('hostList');
            
            messageDiv.textContent = 'Consultando hosts activos...';
            messageDiv.style.color = '#333';
            hostListDiv.innerHTML = ''; // Limpiar resultados anteriores

            // --- 1. Par√°metros para host.get ---
            const hostParams = {
                output: ["hostid", "name", "status", "available"], // name es el alias
                selectInterfaces: ["interfaceid", "ip"], // Obtener la IP para m√°s detalle
                filter: {
                    // Opcional: Solo mostrar hosts habilitados (status: 0)
                    "status": [0] 
                },
                sortfield: "name"
            };

            try {
                // --- 2. Llamar al m√©todo host.get ---
                const data = await makeApiCall("host.get", hostParams, authToken);
                
                if (data.error) {
                    messageDiv.style.color = 'red';
                    messageDiv.textContent = `üö´ Error de API: ${data.error.data || data.error.message}. Verifica el token y los permisos.`;
                } else if (data.result && data.result.length > 0) {
                    const hosts = data.result;
                    messageDiv.style.color = 'green';
                    messageDiv.textContent = `‚úÖ ${hosts.length} "Vuelos" (Hosts) encontrados.`;

                    // --- 3. Generar la tabla de resultados ---
                    let tableHTML = '<table>';
                    tableHTML += '<thead><tr><th>Host ID</th><th>Host (Vuelo)</th><th>IP Principal</th><th>Estado de Monitoreo</th><th>Estado Agente Zabbix</th></tr></thead><tbody>';

                    hosts.forEach(host => {
                        const ipAddress = host.interfaces && host.interfaces.length > 0 ? host.interfaces[0].ip : 'N/A';
                        const statusClass = host.status == 0 ? 'status-0' : 'status-1';
                        
                        tableHTML += `
                            <tr>
                                <td>${host.hostid}</td>
                                <td><strong>${host.name}</strong></td>
                                <td>${ipAddress}</td>
                                <td class="${statusClass}">${getHostStatusText(host.status)}</td>
                                <td>${getAgentAvailability(host.available)}</td>
                            </tr>
                        `;
                    });

                    tableHTML += '</tbody></table>';
                    hostListDiv.innerHTML = tableHTML;

                } else {
                    messageDiv.style.color = 'orange';
                    messageDiv.textContent = `‚ö†Ô∏è No se encontraron "vuelos" (hosts) activos o accesibles.`;
                }

            } catch (error) {
                messageDiv.style.color = 'red';
                messageDiv.textContent = `‚ùå Error de conexi√≥n: ${error.message}`;
            }
        }
    </script>
</body>
</html>